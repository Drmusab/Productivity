# نظرة معمارية شاملة

هذا المستند يشرح حالة المستودع الحالية باللغة العربية، مع تفصيل **لماذا** توجد الملفات، **ماذا** تقدم، **كيف** تُستخدم، **متى** تُستدعى، **أين** تقع، و**المنهجية** المتبعة لكل جزء أساسي.

## شجرة البنية الحالية
```
root/
  README.md                  -> دليل المنتج ونقطة بداية سريعة؛ يوضح لماذا/ماذا يفعل المشروع وكيف يُشغَّل.
  package.json               -> تعريف الحزم والنصوص؛ يحدد كيف يُبنى ويُدار العمل ومتى تُشغَّل الأوامر.
  tsconfig.json              -> ضبط TypeScript الجذري؛ يحدد أين توجد المشاريع المرجعية وكيف تُحل المسارات.
  docker-compose.yml         -> تشغيل الخدمات بالدولكر؛ يشرح متى وأين تُستخدم الحاويات للتطوير/الإنتاج.
  .env.example               -> قيم البيئة الافتراضية؛ يحدد ماذا ولماذا تحتاجه الخدمات.
  apps/
    backend/ ✅ Entry: src/app.ts -> نقطة دخول الخادم Express؛ كيف يبدأ، ماذا يفعّل، ومتى يشغّل الخدمات الخلفية.
      src/
        routes/              -> مجمعات نقاط النهاية لكل ميزة (tasks, boards, ai, notes...): أين تعيش وحدات التحكم.
        services/            -> مهام مجدولة وخادم تعاوني وخدمات الدرجات/البلوكات: كيف تُدار البنية التحتية.
        repositories/        -> مستودعات المستخدم/الرموز: لماذا وكيف تفصل الوصول للبيانات.
        middleware/          -> التوقيت، التعقيم، الحد من المعدل، معالجة الأخطاء: متى تُنفَّذ طبقات الحماية.
        utils/               -> مساعدات SQLite، سجل الأحداث، مرفقات: أين توضع الأدوات المشتركة وكيف تُستهلك.
        config/              -> قراءة البيئة وتهيئة Swagger: كيف تُبنى الإعدادات ولماذا مركزية.
        worker.ts            -> دخول المهام الخلفية: متى تُشغَّل الأعمال غير المتزامنة.
    desktop/ ✅ Entry: src/index.tsx -> نقطة دخول React (CRA) لواجهة المستخدم؛ كيف تُركّب App ومتى تُحمّل المزودات.
      src/
        App.tsx              -> الراوتر والمزودات (مصادقة/إشعارات/سمة): ماذا يغلّف التجربة وكيف يربط الصفحات.
        components/          -> مكونات UI مشتركة (Navbar، ErrorBoundary...): أين تُعاد الاستخدام ولماذا.
        pages/               -> الشاشات الوظيفية (Boards, Planner, Habits, AI notes...): ماذا يرى المستخدم وأين المنطق الخاص.
        contexts/            -> سياقات Auth/Theme/Notification: كيف تُدار الحالة المشتركة ومتى تُستهلك.
        services/            -> عملاء API والتخزين: كيف وأين يتم الاتصال بالخلفية أو التخزين المحلي.
        editor/              -> إعداد محرر Lexical والإضافات: لماذا/كيف يُقدَّم تحرير النص.
        styles/              -> CSS عام وثيمات: أين تُعرّف الهوية البصرية.
        utils/               -> أدوات واختبارات مساعدة: كيف تدعم المكونات والصفحات.
  packages/
    core/                    -> تحليل Markdown/Wikilink وأدوات الرسم البياني: لماذا تُستخدم للمعرفة والرابطية.
    db/                      -> محولات IndexedDB/Yjs: كيف وأين تُدار المزامنة/الاستخدام دون اتصال.
    ui/                      -> مكونات UI مشتركة: ماذا يقدم من تصميم قابل لإعادة الاستخدام.
    modules/                 -> وحدات ميزات قابلة لإعادة الاستخدام (مثال itasks): كيف تفصل المنطق القابل للمشاركة.
    shared/                  -> أنواع/أدوات قديمة: متى وأين تُستخدم لحين الترحيل.
  infra/
    docker/                  -> Compose وDockerfiles: كيف/متى يُدار البنية التحتية.
  scripts/                   -> سكربتات هجرة/نسخ احتياطي: لماذا/كيف تدعم التشغيل والصيانة.
  docs/                      -> أدلة المستخدم والمعمارية: أين تُوثَّق القرارات.
```

## شرح الملفات والمحاور الرئيسية (لماذا/ماذا/كيف/متى/أين/المنهجية)
- **README.md**: يشرح *لماذا* و*ماذا* عن المنتج، *كيف* يُثبَّت، *متى* تُستخدم الأوامر الأساسية، *أين* تقع المزايا في الشجرة، و*المنهجية* العامة للتشغيل.
- **package.json**: يحدد الحزم والنصوص لتثبيت/تشغيل/اختبار؛ يوضح *متى* يُستخدم كل سكربت (dev, build, docker)، *كيف* تُدار العملspaces، و*لماذا* تعتمد على Node 18.
- **tsconfig.json**: يضبط مسارات/مراجع TypeScript حتى تعرف الأدوات *أين* توجد المشاريع الفرعية و*كيف* تُحل الواردات المشتركة.
- **docker-compose.yml**: يوضح متى تحتاج حاويات قاعدة البيانات/الخلفية، *كيف* تُشغَّل باستخدام الملفات في `infra/docker`, وأين تُعرَّف الملفات البيئية.
- **.env.example**: يبيّن ما هي المتغيرات المطلوبة، *لماذا* مطلوبة (مسار قاعدة البيانات، مفاتيح JWT)، و*كيف* تضبط القيم محليًا دون كشف أسرار.
- **apps/backend/src/app.ts**: نقطة الدخول التي تُكوّن Express، *كيف* تُربط الوسائط والراوترات، *متى* يبدأ الملقم وSocket.IO، و*المنهجية* المتبعة لتهيئة DB والمجدول.
- **apps/backend/src/routes/**: كل ملف يحدد *ماذا* يقدم من نقاط نهاية لكل ميزة، *كيف* يترجم الطلبات إلى عمليات DB/خدمات، و*أين* تُجمع في التطبيق.
- **apps/backend/src/utils/database.ts**: يحدد *كيف* يُفتح اتصال SQLite، *متى* تُنشأ الجداول وتُملأ، و*لماذا* يجب توحيد مسار DB.
- **apps/desktop/src/index.tsx**: يدخل React ويحقن المزودات؛ يوضح *كيف* يُرَكّب التطبيق و*متى* يُنفّذ قبل ظهور الواجهة.
- **apps/desktop/src/App.tsx**: يضبط الراوتر والحراسة بالمصادقة؛ *ماذا* يعرض من تخطيطات، *كيف* يختار الثيم، و*متى* يمنع الوصول غير المصرّح به.
- **packages/ui/**: يحدد *كيف* يُعاد استخدام مكونات التصميم، *أين* يستهلكها الويب/الديسكتوب، و*المنهجية* لتوحيد التجربة البصرية.
- **packages/db/**: يشرح *كيف* تُدار المزامنة وIndexedDB/Yjs، *متى* تُستخدم للنسخ دون اتصال، و*أين* تتكامل مع الواجهة.

## خريطة المعمارية
- **نقاط الدخول**
  - الواجهة الأمامية: `apps/desktop/src/index.tsx` يشغّل React، يحقن المزودات، ويقود التوجيه.
  - الخادم الخلفي: `apps/backend/src/app.ts` يهيئ Express وSocket.IO، يبدأ SQLite، ويثبت الخدمات.
  - العامل الخلفي: `apps/backend/src/worker.ts` لتشغيل المهام المجدولة/الخلفية عند الحاجة.

- **تدفق التشغيل**
  1. تشغيل الخادم: قراءة البيئة، إضافة الوسائط الأمنية (helmet، rate limit، sanitization)، فتح SQLite، تشغيل الهجرات والتعبئة، بدء خادم التعاون والمجدول، ثم تحميل الراوترات وSwagger.
  2. تشغيل الواجهة: تحميل React مع مزودات Theme/Auth/Notification، ثم تفعيل الراوتر الذي يفرض المصادقة على معظم الصفحات.
  3. التفاعل: الواجهة تستدعي REST APIs لكل ميزة (مهام، ملاحظات، AI...)، وتستخدم Socket.IO للتعاون عند الحاجة.

- **خريطة الوحدات**
  - المصادقة: سياق Auth في React + حمايات المسار؛ خلفية users/tokens في routes وrepositories.
  - المهام/كانبان: صفحات Boards/Board؛ خلفية `routes/tasks.ts` و`routes/boards.ts`.
  - المخطط/العادات/اللياقة/الإسلامية: صفحات مخصصة تحت `apps/desktop/src/pages/` مع راوترات خلفية موازية.
  - الملاحظات/المعرفة/Obsidian: صفحات NotesHub/KnowledgeVault؛ خلفية `routes/notes.ts`, `routes/obsidianNotes.ts`, `routes/knowledgeVault.ts`.
  - الذكاء الاصطناعي: واجهة AI Notes/Assist؛ خلفية `routes/ai.ts`, `routes/aiNotes.ts`.
  - الأتمتة/التكاملات: خلفية `routes/automation.ts`, `routes/integrations.ts`؛ الوثائق تشير لتكامل n8n.
  - إدارة الحالة: سياقات React (Theme/Auth/Notification)، لا توجد مكتبة حالة مركزية.
  - المكونات: مشتركة في `packages/ui` وخاصة في `apps/desktop/src/components`.
  - التخزين/البيانات: SQLite عبر `utils/database.ts`; التخزين دون اتصال عبر IndexedDB/Yjs في `packages/db`.

- **نظرة على نماذج البيانات**
  - الأنواع موزعة بين `apps/backend/src/types` وبعض الخدمات؛ الجداول تُنشأ برمجياً أثناء تهيئة DB.
  - الإعدادات البيئية تضبط مسار قاعدة البيانات ومفاتيح JWT وخيارات الميزات في `.env.example`.
  - لا يوجد فصل واضح بين الراوتر/الخدمة/المستودع؛ غالباً يتم الوصول للبيانات مباشرة من الراوتر.

## المشكلات والمخاطر
- **عدم اتساق مسار قاعدة البيانات**: `.env.example` يستخدم `./data/productivity.db` بينما `utils/database.ts` يfallback إلى `../../data/kanban.db`، مما يخلق ملفات مختلفة حسب بيئة التشغيل.
- **تشغيل خلفي أحادي الكتلة**: `app.ts` يجمع الوسائط والراوترات وSocket.IO والمجدول وSwagger وتهيئة DB في ملف واحد، مما يصعّب الاختبار والتوسعة.
- **أداة DB تدمج البنية مع المجال**: `utils/database.ts` تنشئ الجداول وتعبئها بالإضافة للاتصال، ما يسبب ترابطاً قوياً وربما دورات استيراد.
- **التوجيه في الواجهة يعتمد BrowserRouter**: في سيناريوهات سطح المكتب/offline، قد يسبب مشاكل عند التغليف؛ الحراسة بالمصادقة داخل المكونات قد تسمح بوميض محتوى غير مصرح به.

## شجرة مستهدفة مقترحة (مع المنهجية)
```
apps/
  backend/
    src/
      main.ts                  # خادم بسيط للتشغيل؛ يحدد متى يبدأ HTTP وSocket.
      server/
        index.ts               # مصنع Express يربط الوسائط والصحة وSwagger؛ يوضح كيف تُجمّع طبقات HTTP.
        routes/                # تسجيل الراوترات؛ أين تُجمع نقاط النهاية.
        middleware/            # وسائط مشتركة (أمن/قياس)؛ المنهجية: طبقات رقيقة قابلة للاختبار.
      modules/
        tasks/                 # controllers/services/repositories/validators لكل ميزة.
        notes/
        automation/
        ...
      infra/
        db/                    # اتصال SQLite + هجرات؛ فصل البنية عن المجال.
        scheduler/             # إعداد cron/jobs؛ متى تُشغَّل الوظائف.
        realtime/              # Socket/Collaboration؛ كيف يُدار التواصل.
      config/                  # تحميل البيئة وتهيئة القيم الافتراضية.
      workers/                 # نقاط دخول للمهام الخلفية.
  desktop/
    src/
      main.tsx                 # يختار الراوتر (browser/hash) حسب البيئة؛ يشرح متى يستخدم كل واحد.
      app/
        App.tsx                # المزودات والتخطيطات؛ كيف تُنسق التجربة.
        routes/                # تعريف المسارات لكل ميزة.
      features/                # مجلد لكل ميزة (boards، planner، notes، ai...).
      shared/                  # مكونات/هوكات/سياقات مشتركة.
      services/                # عملاء API والتخزين.
packages/
  core/                        # نماذج وأنواع مشتركة.
  db/                          # محولات التخزين دون اتصال.
  ui/                          # مكونات التصميم النظامي.
  modules/                     # منطق ميزات قابل لإعادة الاستخدام.
  shared/                      # عناصر قديمة قيد الترحيل.
infra/
  docker/                      # Compose وDockerfiles.
scripts/                       # أدوات الهجرة/النسخ الاحتياطي.
```

## الخطوات التالية المقترحة
1. توحيد مسار قاعدة البيانات عبر config مركزي واستخدامه في `utils/database` دون قيم صلبة.
2. فصل التشغيل الخلفي إلى `main.ts` و`server/index.ts` مع تجميع راوتر في `server/routes/index.ts`.
3. نقل منطق الميزة إلى `modules/<feature>` مع فصل controller/service/repository والربط عبر الراوترات.
4. استخراج الهجرات/إنشاء الجداول إلى `infra/db` مع مشغّل هجرات، وإبقاء أداة DB للاتصال والاستعلام فقط.
5. تغليف إعداد Socket.IO والمجدول في وحدات `infra` قابلة للحقن لتقليل الترابط.
6. في الواجهة، إنشاء مركزية للتوجيه في `src/app/routes` واختيار Router مناسب للبيئة لتجنب مشاكل التغليف.
7. نقل المزودات المشتركة إلى `src/app/providers` وإضافة حالة تحميل للمصادقة لمنع وميض الصفحات غير المصرح بها.
8. مراجعة التداخل بين `packages/shared` و`packages/core/modules` ووضع خطة ترحيل لإزالة الأدوات المكررة.
9. تحديث الوثائق بعد إعادة الهيكلة وإضافة اختبارات لـ config ومسار DB وتشغيل مصنع التطبيق.
